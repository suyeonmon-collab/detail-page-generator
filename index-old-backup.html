<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏûêÎèô ÏÉùÏÑ±Í∏∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #5b6ef5 0%, #3f51b5 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #5b6ef5;
            background: white;
            box-shadow: 0 0 0 3px rgba(91, 110, 245, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .image-upload-area {
            border: 2px dashed #5b6ef5;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            background: #f0f2ff;
            border-color: #3f51b5;
        }

        .image-upload-area.dragover {
            background: #e8f0fe;
            border-color: #1a73e8;
        }

        .upload-icon {
            font-size: 48px;
            color: #5b6ef5;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #666;
        }

        .image-preview {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .image-preview .remove-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .template-option {
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .template-option:hover {
            border-color: #5b6ef5;
            background: #f8f9ff;
        }

        .template-option.selected {
            border-color: #5b6ef5;
            background: #e8f0fe;
        }

        .template-preview {
            width: 100%;
            height: 120px;
            background: #e1e5e9;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
        }

        .submit-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #5b6ef5 0%, #3f51b5 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(91, 110, 245, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5b6ef5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            padding: 40px;
            text-align: center;
        }

        .result.success {
            background: #f0f9ff;
            border-radius: 12px;
            margin-top: 20px;
        }

        .result h3 {
            color: #059669;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .result p {
            color: #374151;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .download-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #059669;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            margin: 0 8px;
        }

        .download-btn:hover {
            background: #047857;
        }

        .ai-preview-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .editable-content {
            margin-bottom: 30px;
        }

        .editable-content textarea {
            font-family: inherit;
            line-height: 1.6;
            border: 2px solid #e1e5e9;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .editable-content textarea:focus {
            border-color: #5b6ef5;
            background: white;
            box-shadow: 0 0 0 3px rgba(91, 110, 245, 0.1);
        }

        .image-reupload-section {
            margin-top: 30px;
        }

        .image-upload-area-small {
            border: 2px dashed #5b6ef5;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area-small:hover {
            background: #f0f2ff;
            border-color: #3f51b5;
        }

        .image-preview-small {
            margin-top: 16px;
            text-align: center;
        }

        .image-preview-small img {
            max-width: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .live-preview {
            background: white;
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8;
            white-space: pre-wrap;
            border: 1px solid #e1e5e9;
        }

        .current-image-status {
            margin-bottom: 12px;
        }

        .current-image-status p {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 16px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .template-selector {
                grid-template-columns: 1fr;
            }

            .ai-preview-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏûêÎèô ÏÉùÏÑ±Í∏∞</h1>
            <p>Í∞ÑÎã®Ìïú Ï†ïÎ≥¥ ÏûÖÎ†•ÏúºÎ°ú Ï†ÑÎ¨∏Ï†ÅÏù∏ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî</p>
        </div>

        <div class="form-container">
            <form id="detailPageForm">
                <div class="form-group">
                    <label for="productName">ÏÉÅÌíàÎ™Ö *</label>
                    <input type="text" id="productName" name="productName" placeholder="Ïòà: ÌîÑÎ¶¨ÎØ∏ÏóÑ Î°úÏ¶àÏõåÌÑ∞ ÌÜ†ÎÑà" required>
                </div>

                <div class="form-group">
                    <label for="productDescription">ÏÉÅÌíà ÏÑ§Î™Ö *</label>
                    <textarea id="productDescription" name="productDescription" placeholder="ÏÉÅÌíàÏùò ÌäπÏßï, Ìö®Í≥º, ÏÇ¨Ïö©Î≤ï Îì±ÏùÑ ÏûêÏÑ∏Ìûà ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="targetAudience">ÌÉÄÍ≤ü Í≥†Í∞ùÏ∏µ</label>
                    <select id="targetAudience" name="targetAudience">
                        <option value="20-30ÎåÄ Ïó¨ÏÑ±">20-30ÎåÄ Ïó¨ÏÑ±</option>
                        <option value="30-40ÎåÄ Ïó¨ÏÑ±">30-40ÎåÄ Ïó¨ÏÑ±</option>
                        <option value="20-30ÎåÄ ÎÇ®ÏÑ±">20-30ÎåÄ ÎÇ®ÏÑ±</option>
                        <option value="30-40ÎåÄ ÎÇ®ÏÑ±">30-40ÎåÄ ÎÇ®ÏÑ±</option>
                        <option value="Ï†ÑÏ≤¥ Ïó∞Î†π">Ï†ÑÏ≤¥ Ïó∞Î†π</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="productCategory">ÏÉÅÌíà Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                    <select id="productCategory" name="productCategory">
                        <option value="Î∑∞Ìã∞/ÌôîÏû•Ìíà">Î∑∞Ìã∞/ÌôîÏû•Ìíà</option>
                        <option value="Ìå®ÏÖò/ÏùòÎ•ò">Ìå®ÏÖò/ÏùòÎ•ò</option>
                        <option value="ÏÉùÌôúÏö©Ìíà">ÏÉùÌôúÏö©Ìíà</option>
                        <option value="ÏãùÌíà/Í±¥Í∞ï">ÏãùÌíà/Í±¥Í∞ï</option>
                        <option value="Ï†ÑÏûêÏ†úÌíà">Ï†ÑÏûêÏ†úÌíà</option>
                        <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</label>
                    <div class="image-upload-area" id="imageUploadArea">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏóÖÎ°úÎìú</div>
                        <div class="upload-subtext">JPG, PNG ÌååÏùºÎßå Í∞ÄÎä• (ÏµúÎåÄ 10MB)</div>
                        <input type="file" id="productImage" name="productImage" accept="image/*" style="display: none;">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg" src="" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">
                        <br>
                        <button type="button" class="remove-btn" onclick="removeImage()">Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù</label>
                    <div class="template-selector">
                        <div class="template-option" data-template="minimal">
                            <div class="template-preview">ÎØ∏ÎãàÎ©Ä Ïä§ÌÉÄÏùº</div>
                            <div>ÍπîÎÅîÌïòÍ≥† Ïã¨ÌîåÌïú ÎîîÏûêÏù∏</div>
                        </div>
                        <div class="template-option" data-template="modern">
                            <div class="template-preview">Î™®Îçò Ïä§ÌÉÄÏùº</div>
                            <div>Ìä∏Î†åÎîîÌïòÍ≥† ÏÑ∏Î†®Îêú ÎîîÏûêÏù∏</div>
                        </div>
                        <div class="template-option" data-template="luxury">
                            <div class="template-preview">Îü≠ÏÖîÎ¶¨ Ïä§ÌÉÄÏùº</div>
                            <div>Í≥†Í∏âÏä§ÎüΩÍ≥† Ïö∞ÏïÑÌïú ÎîîÏûêÏù∏</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customerEmail">Ïù¥Î©îÏùº Ï£ºÏÜå *</label>
                    <input type="email" id="customerEmail" name="customerEmail" placeholder="ÏôÑÏÑ±Îêú ÎîîÏûêÏù∏ÏùÑ Î∞õÏùÑ Ïù¥Î©îÏùº Ï£ºÏÜå" required>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    üöÄ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÉùÏÑ±ÌïòÍ∏∞
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
                <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî (ÏïΩ 1-2Î∂Ñ ÏÜåÏöî)</p>
            </div>

            <div class="result" id="result">
                <h3>‚úÖ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å!</h3>
                <p>ÏöîÏ≤≠ÌïòÏã† ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.</p>
                <p>ÏôÑÏÑ±Îêú ÌååÏùºÏù¥ Ïù¥Î©îÏùºÎ°ú Ï†ÑÏÜ°Îê©ÎãàÎã§.</p>
                <a href="#" class="download-btn" id="figmaLink" target="_blank">Figma ÌååÏùº Î≥¥Í∏∞</a>
                <a href="#" class="download-btn" id="pngLink" target="_blank">PNG Îã§Ïö¥Î°úÎìú</a>
            </div>

            <div class="error" id="errorMessage"></div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ ÏÑ∏ÏÖò Í∞ùÏ≤¥
        let currentSession = {
            requestId: null,
            aiContent: null,
            editedContent: null,
            hasImage: false,
            hasNewImage: false,
            newImageData: null
        };

        const API_BASE = 'https://detail-page-generator.netlify.app/api';

        // ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù
        document.querySelectorAll('.template-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        const imageUploadArea = document.getElementById('imageUploadArea');
        const productImage = document.getElementById('productImage');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        imageUploadArea.addEventListener('click', () => productImage.click());

        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });

        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });

        productImage.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('ÌååÏùº ÌÅ¨Í∏∞Îäî 10MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                currentSession.hasImage = true;
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            productImage.value = '';
            imagePreview.style.display = 'none';
            previewImg.src = '';
            currentSession.hasImage = false;
        }

        // Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
        document.getElementById('detailPageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedTemplate = document.querySelector('.template-option.selected');
            
            if (!selectedTemplate) {
                alert('ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // UI ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                // Ïù¥ÎØ∏ÏßÄÎ•º base64Î°ú Î≥ÄÌôò
                let imageData = null;
                const imageFile = document.getElementById('productImage').files[0];
                if (imageFile) {
                    imageData = await fileToBase64(imageFile);
                }

                // JSON Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const requestData = {
                    productName: document.getElementById('productName').value,
                    productDescription: document.getElementById('productDescription').value,
                    customerEmail: document.getElementById('customerEmail').value,
                    targetAudience: document.getElementById('targetAudience').value,
                    productCategory: document.getElementById('productCategory').value,
                    template: selectedTemplate.dataset.template,
                    imageData: imageData
                };

                const response = await fetch(`${API_BASE}/generate-content`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                // ÏùëÎãµ ÏÉÅÌÉú ÌôïÏù∏
                if (!response.ok) {
                    let errorMessage = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                    try {
                        const errorData = await response.json();
                        console.error('API Error:', response.status, errorData);
                        
                        // ÏπúÏ†àÌïú ÏóêÎü¨ Î©îÏãúÏßÄÎ°ú Î≥ÄÌôò
                        if (errorData.error) {
                            if (errorData.error.includes('ai_content')) {
                                errorMessage = 'AI ÏΩòÌÖêÏ∏† ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî. (OpenAI API ÌÇ§ ÌôïÏù∏ ÌïÑÏöî)';
                            } else if (errorData.error.includes('supabase')) {
                                errorMessage = 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ïò§Î•òÏûÖÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.';
                            } else {
                                errorMessage = errorData.error;
                            }
                        }
                    } catch (e) {
                        const errorText = await response.text();
                        console.error('API Error:', response.status, errorText);
                        errorMessage = `ÏÑúÎ≤Ñ Ïò§Î•ò (${response.status}): API ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.success) {
                    // AI ÎØ∏Î¶¨Î≥¥Í∏∞ ÌôîÎ©¥ ÌëúÏãú
                    currentSession.requestId = result.requestId;
                    currentSession.aiContent = result.aiContent;
                    showAIPreview(result.aiContent);
                } else {
                    throw new Error(result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // AI ÎØ∏Î¶¨Î≥¥Í∏∞ ÌôîÎ©¥ ÌëúÏãú
        function showAIPreview(content) {
            document.getElementById('loading').style.display = 'none';
            
            const previewHtml = `
                <div class="ai-preview-section">
                    <h3>‚ú® AIÍ∞Ä ÏûëÏÑ±Ìïú ÏÉÅÌíà ÏÑ§Î™Ö</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        ÎÇ¥Ïö©Ïù¥ ÎßàÏùåÏóê Îì§ÏßÄ ÏïäÏúºÏãúÎ©¥ ÏïÑÎûòÏóêÏÑú ÏûêÏú†Î°≠Í≤å ÏàòÏ†ïÌïòÏÑ∏Ïöî
                    </p>
                    
                    <!-- ÏàòÏ†ï Í∞ÄÎä•Ìïú ÌÖçÏä§Ìä∏ ÏòÅÏó≠ -->
                    <div class="editable-content">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            üìù ÏÉÅÌíà ÏÑ§Î™Ö (ÏàòÏ†ï Í∞ÄÎä•)
                        </label>
                        <textarea 
                            id="editableContent" 
                            style="
                                width: 100%; 
                                min-height: 300px; 
                                padding: 16px; 
                                border: 2px solid #e1e5e9; 
                                border-radius: 12px;
                                font-size: 15px;
                                line-height: 1.6;
                                resize: vertical;
                            "
                        >${content}</textarea>
                        <p style="font-size: 12px; color: #999; margin-top: 8px;">
                            üí° ÌåÅ: Î¨∏Îã® Íµ¨Î∂Ñ, Ïù¥Î™®ÏßÄ Ï∂îÍ∞Ä, Í∞ïÏ°∞ ÌëúÌòÑ Îì±ÏùÑ ÏûêÏú†Î°≠Í≤å ÏàòÏ†ïÌïòÏÑ∏Ïöî
                        </p>
                    </div>
                    
                    <!-- Ïù¥ÎØ∏ÏßÄ Ïû¨ÏóÖÎ°úÎìú ÏòÅÏó≠ -->
                    <div class="image-reupload-section">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            üñºÔ∏è ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                        </label>
                        <div class="current-image-status" id="currentImageStatus">
                            ${currentSession.hasImage ? 
                                '<p style="color: #059669;">‚úÖ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÖÎ°úÎìúÎêòÏñ¥ ÏûàÏäµÎãàÎã§</p>' : 
                                '<p style="color: #f59e0b;">‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</p>'
                            }
                        </div>
                        <div class="image-upload-area-small" id="reuploadArea">
                            <div style="font-size: 32px; margin-bottom: 8px;">üì∑</div>
                            <div style="font-size: 14px; color: #333;">
                                ${currentSession.hasImage ? 'Îã§Î•∏ Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÍ≤ΩÌïòÍ∏∞' : 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÌïòÍ∏∞'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù (JPG, PNG / ÏµúÎåÄ 10MB)
                            </div>
                            <input 
                                type="file" 
                                id="reuploadImage" 
                                accept="image/*" 
                                style="display: none;"
                            >
                        </div>
                        <div class="image-preview-small" id="reuploadPreview" style="display: none;">
                            <img id="reuploadPreviewImg" style="max-width: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <br>
                            <button 
                                type="button" 
                                onclick="removeReuploadedImage()"
                                style="
                                    margin-top: 8px;
                                    padding: 8px 16px;
                                    background: #ff4757;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 13px;
                                ">
                                Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÏàòÏ†ï ÏôÑÎ£å Î≤ÑÌäº -->
                    <div style="margin-top: 30px; display: flex; gap: 12px;">
                        <button 
                            onclick="requestDesignGeneration()" 
                            class="submit-btn"
                            style="flex: 1;">
                            üé® Ïù¥ ÎÇ¥Ïö©ÏúºÎ°ú ÎîîÏûêÏù∏ ÏÉùÏÑ±ÌïòÍ∏∞
                        </button>
                        <button 
                            onclick="resetForm()" 
                            style="
                                flex: 0.3;
                                padding: 16px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 16px;
                                cursor: pointer;
                            ">
                            ‚Ü∫ Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú
                        </button>
                    </div>
                    
                    <!-- ÎØ∏Î¶¨Î≥¥Í∏∞ ÏòÅÏó≠ -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <h4 style="margin-bottom: 12px;">üëÄ ÏàòÏ†ïÎêú ÎÇ¥Ïö© ÎØ∏Î¶¨Î≥¥Í∏∞:</h4>
                        <div 
                            id="livePreview" 
                            class="live-preview"
                        >${content}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('result').innerHTML = previewHtml;
            document.getElementById('result').style.display = 'block';
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
            setupEditListeners();
        }

        // ÏàòÏ†ï Í¥ÄÎ†® Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEditListeners() {
            // ÌÖçÏä§Ìä∏ Ïã§ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞
            const editableContent = document.getElementById('editableContent');
            const livePreview = document.getElementById('livePreview');
            
            editableContent.addEventListener('input', (e) => {
                livePreview.textContent = e.target.value;
                currentSession.editedContent = e.target.value;
            });
            
            // Ïù¥ÎØ∏ÏßÄ Ïû¨ÏóÖÎ°úÎìú
            const reuploadArea = document.getElementById('reuploadArea');
            const reuploadImage = document.getElementById('reuploadImage');
            
            reuploadArea.addEventListener('click', () => {
                reuploadImage.click();
            });
            
            reuploadImage.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    if (!file.type.startsWith('image/')) {
                        alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                        return;
                    }
                    
                    if (file.size > 10 * 1024 * 1024) {
                        alert('ÌååÏùº ÌÅ¨Í∏∞Îäî 10MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.');
                        return;
                    }
                    
                    // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('reuploadPreviewImg').src = e.target.result;
                        document.getElementById('reuploadPreview').style.display = 'block';
                        document.getElementById('currentImageStatus').innerHTML = 
                            '<p style="color: #059669;">‚úÖ ÏÉà Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§</p>';
                    };
                    reader.readAsDataURL(file);
                    
                    // base64Î°ú Ï†ÄÏû•
                    currentSession.newImageData = await fileToBase64(file);
                    currentSession.hasNewImage = true;
                }
            });
        }

        function removeReuploadedImage() {
            document.getElementById('reuploadImage').value = '';
            document.getElementById('reuploadPreview').style.display = 'none';
            document.getElementById('reuploadPreviewImg').src = '';
            currentSession.newImageData = null;
            currentSession.hasNewImage = false;
            document.getElementById('currentImageStatus').innerHTML = 
                '<p style="color: #f59e0b;">‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§</p>';
        }

        function resetForm() {
            if (confirm('Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                location.reload();
            }
        }

        // ÎîîÏûêÏù∏ ÏÉùÏÑ± ÏöîÏ≤≠ (ÏàòÏ†ïÎêú ÎÇ¥Ïö© Ìè¨Ìï®)
        async function requestDesignGeneration() {
            console.log('üé® ÎîîÏûêÏù∏ ÏÉùÏÑ± ÏöîÏ≤≠ ÏãúÏûë');
            
            // ÏµúÏ¢Ö ÏàòÏ†ïÎêú ÎÇ¥Ïö© ÌôïÏù∏
            const finalContent = document.getElementById('editableContent').value;
            
            if (!finalContent || finalContent.trim().length < 50) {
                alert('ÏÉÅÌíà ÏÑ§Î™ÖÏù¥ ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§. ÏµúÏÜå 50Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentSession.requestId) {
                alert('ÏÑ∏ÏÖò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            console.log('üì§ Request ID:', currentSession.requestId);
            console.log('üìù Final Content Í∏∏Ïù¥:', finalContent.length);
            
            showLoading('ÏàòÏ†ïÌïòÏã† ÎÇ¥Ïö©ÏúºÎ°ú Ï†ÑÎ¨∏ ÎîîÏûêÏù∏ÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...');
            
            const data = {
                requestId: currentSession.requestId,
                finalContent: finalContent,
                hasNewImage: currentSession.hasNewImage,
                newImageData: currentSession.newImageData
            };
            
            try {
                console.log('üöÄ API Ìò∏Ï∂ú:', `${API_BASE}/request-design`);
                
                const response = await fetch(`${API_BASE}/request-design`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('üì• ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò (${response.status}): ${errorText || 'API ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.'}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);
                
                if (result.success) {
                    console.log('üîÑ Ìè¥ÎßÅ ÏãúÏûë');
                    // Ìè¥ÎßÅ ÏãúÏûë
                    pollDesignStatus();
                } else {
                    throw new Error(result.error || 'ÎîîÏûêÏù∏ ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('‚ùå ÎîîÏûêÏù∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
                hideLoading();
                showError('ÎîîÏûêÏù∏ ÏÉùÏÑ± ÏöîÏ≤≠ Ï§ë Ïò§Î•ò: ' + error.message);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showLoading(message) {
            document.getElementById('loading').innerHTML = `
                <div class="spinner"></div>
                <p>${message}</p>
                <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...</p>
            `;
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function pollDesignStatus() {
            console.log('üîÑ Ìè¥ÎßÅ ÏãúÏûë - Request ID:', currentSession.requestId);
            
            const pollInterval = setInterval(async () => {
                try {
                    console.log('‚è∞ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...');
                    const response = await fetch(`${API_BASE}/check-status?requestId=${currentSession.requestId}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Status Check Error:', response.status, errorText);
                        throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò (${response.status}): ${errorText || 'API ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.'}`);
                    }
                    
                    const result = await response.json();
                    console.log('üìä ÏÉÅÌÉú:', result.status, result);
                    
                    if (result.status === 'completed') {
                        console.log('‚úÖ ÏôÑÎ£å!');
                        clearInterval(pollInterval);
                        hideLoading();
                        showFinalResult(result);
                    } else if (result.status === 'error') {
                        console.error('‚ùå ÏóêÎü¨ ÏÉÅÌÉú');
                        clearInterval(pollInterval);
                        hideLoading();
                        showError('ÎîîÏûêÏù∏ ÏÉùÏÑ± Ï§ë Ïò§Î•ò: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                    } else {
                        console.log('‚è≥ ÎåÄÍ∏∞ Ï§ë... (status:', result.status + ')');
                    }
                    // statusÍ∞Ä 'pending' ÎòêÎäî 'design_pending'Ïù¥Î©¥ Í≥ÑÏÜç Ìè¥ÎßÅ
                } catch (error) {
                    console.error('‚ùå Ìè¥ÎßÅ Ïò§Î•ò:', error);
                    clearInterval(pollInterval);
                    hideLoading();
                    showError('ÏÉÅÌÉú ÌôïÏù∏ Ï§ë Ïò§Î•ò: ' + error.message);
                }
            }, 3000); // 3Ï¥àÎßàÎã§ ÌôïÏù∏
        }

        function showFinalResult(result) {
            document.getElementById('result').innerHTML = `
                <h3>‚úÖ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å!</h3>
                <p>ÏöîÏ≤≠ÌïòÏã† ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.</p>
                <p>ÏôÑÏÑ±Îêú ÌååÏùºÏù¥ Ïù¥Î©îÏùºÎ°ú Ï†ÑÏÜ°Îê©ÎãàÎã§.</p>
                <a href="${result.figmaLink}" class="download-btn" target="_blank">Figma ÌååÏùº Î≥¥Í∏∞</a>
                <a href="${result.pngLink}" class="download-btn" target="_blank">PNG Îã§Ïö¥Î°úÎìú</a>
            `;
            document.getElementById('result').style.display = 'block';
        }

        // Í∏∞Î≥∏ ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù
        document.querySelector('.template-option[data-template="modern"]').classList.add('selected');
    </script>
</body>
</html>