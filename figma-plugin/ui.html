<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í…œí”Œë¦¿ ì›¹ í¸ì§‘ ì„¤ì •</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body { 
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0;
      padding: 16px;
      background: #f8f9fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      margin: -16px -16px 24px -16px;
      border-radius: 0 0 12px 12px;
      text-align: center;
    }
    
    .header h1 { 
      margin: 0 0 8px; 
      font-size: 20px; 
      font-weight: 600;
    }
    
    .header p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .file-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 12px;
    }

    .file-info strong {
      color: #1976d2;
    }

    .auto-edit-notice {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .notice-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .notice-text {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .notice-subtext {
      font-size: 12px;
      opacity: 0.9;
    }

    .layer-summary {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      font-size: 14px;
      color: #666;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
      color: #4caf50;
    }

    .layer-preview {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .layer-preview h4 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #333;
    }

    .layer-list-compact {
      max-height: 200px;
      overflow-y: auto;
    }

    .layer-item-compact {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .layer-item-compact:last-child {
      margin-bottom: 0;
    }

    .layer-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .layer-info {
      flex: 1;
    }

    .layer-name {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .layer-type {
      font-size: 11px;
      color: #666;
    }

    .layer-status {
      font-size: 11px;
      color: #4caf50;
      font-weight: 500;
    }

    .template-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .template-section h3 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #333;
    }

    .template-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .template-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .template-item:hover {
      background: #e9ecef;
      border-color: #667eea;
    }

    .template-item.selected {
      background: #e3f2fd;
      border-color: #1976d2;
    }

    .template-preview {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      margin-right: 12px;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
    }

    .template-info {
      flex: 1;
    }

    .template-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .template-description {
      font-size: 12px;
      color: #666;
    }

    .template-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd8;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-indicator.success {
      background: #4caf50;
    }

    .status-indicator.warning {
      background: #ff9800;
    }

    .status-indicator.error {
      background: #f44336;
    }

    .status-indicator.info {
      background: #2196f3;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666;
    }

    .loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 13px;
      opacity: 0.7;
    }

    .hidden {
      display: none;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¨ í…œí”Œë¦¿ ì›¹ í¸ì§‘ ì„¤ì •</h1>
    <p>ê´€ë¦¬ììš© í…œí”Œë¦¿ ì„¤ì • ë„êµ¬</p>
  </div>

  <div class="file-info" id="fileInfo">
    <strong>íŒŒì¼:</strong> <span id="fileName">ë¡œë”© ì¤‘...</span><br>
    <strong>í‚¤:</strong> <span id="fileKey">ë¡œë”© ì¤‘...</span>
  </div>

  <!-- ìë™ í¸ì§‘ ëª¨ë“œ ì•Œë¦¼ -->
  <div class="auto-edit-notice">
    <div class="notice-icon">ğŸ¤–</div>
    <div class="notice-text">ìë™ í¸ì§‘ ëª¨ë“œ</div>
    <div class="notice-subtext">ëª¨ë“  í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ê°€ ìë™ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤</div>
  </div>

  <!-- ë ˆì´ì–´ ìš”ì•½ -->
  <div class="layer-summary" id="layerSummary" style="display: none;">
    <div class="summary-item">
      <span class="summary-label">ì´ ë ˆì´ì–´:</span>
      <span class="summary-value" id="totalLayers">0ê°œ</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">í¸ì§‘ ê°€ëŠ¥:</span>
      <span class="summary-value" id="editableLayers">0ê°œ</span>
    </div>
  </div>

  <!-- ë ˆì´ì–´ ë¯¸ë¦¬ë³´ê¸° -->
  <div class="layer-preview" id="layerPreview" style="display: none;">
    <h4>í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ ëª©ë¡</h4>
    <div class="layer-list-compact" id="layerListCompact">
      <!-- ë ˆì´ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <!-- í…œí”Œë¦¿ ê´€ë¦¬ ì„¹ì…˜ -->
  <div class="template-section">
    <h3>ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬</h3>
    
    <div class="form-group">
      <button class="btn btn-primary" onclick="loadTemplateList()">
        ğŸ“‹ í…œí”Œë¦¿ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      </button>
    </div>

    <div id="templateList" class="template-list" style="display: none;">
      <!-- í…œí”Œë¦¿ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <div id="templateForm" style="display: none;">
      <div class="form-group">
        <label for="templateName">í…œí”Œë¦¿ ì´ë¦„</label>
        <input type="text" id="templateName" placeholder="í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      
      <div class="form-group">
        <label for="templateDescription">ì„¤ëª…</label>
        <textarea id="templateDescription" placeholder="í…œí”Œë¦¿ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>
      
      <div class="form-group">
        <button class="btn btn-success" onclick="saveTemplate()">
          ğŸ’¾ í…œí”Œë¦¿ ì €ì¥
        </button>
        <button class="btn btn-secondary" onclick="cancelTemplateForm()">
          âŒ ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- ìƒíƒœ í‘œì‹œ -->
  <div id="statusMessage" style="display: none;"></div>

  <script>
    let currentLayers = [];
    let currentTemplates = [];
    let selectedTemplate = null;

    // í”ŒëŸ¬ê·¸ì¸ê³¼ í†µì‹ í•˜ëŠ” í•¨ìˆ˜
    function post(type, payload = {}) {
      parent.postMessage({ pluginMessage: { type, payload } }, '*');
    }

    // íŒŒì¼ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateFileInfo(fileInfo) {
      document.getElementById('fileName').textContent = fileInfo.fileName || 'Unknown';
      document.getElementById('fileKey').textContent = fileInfo.fileKey || 'Unknown';
    }

    // ë ˆì´ì–´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    function displayLayerAnalysis(data) {
      currentLayers = data.layers || [];
      
      // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('totalLayers').textContent = `${currentLayers.length}ê°œ`;
      document.getElementById('editableLayers').textContent = `${currentLayers.filter(layer => layer.editable).length}ê°œ`;
      
      // ë ˆì´ì–´ ëª©ë¡ ìƒì„±
      const layerListHtml = currentLayers.map(layer => `
        <div class="layer-item-compact">
          <div class="layer-icon">${getLayerIcon(layer.type)}</div>
          <div class="layer-info">
            <div class="layer-name">${layer.name}</div>
            <div class="layer-type">${layer.type} - ${layer.editType}</div>
          </div>
          <div class="layer-status">âœ… í¸ì§‘ ê°€ëŠ¥</div>
        </div>
      `).join('');
      
      document.getElementById('layerListCompact').innerHTML = layerListHtml;
      
      // ì„¹ì…˜ í‘œì‹œ
      document.getElementById('layerSummary').style.display = 'block';
      document.getElementById('layerPreview').style.display = 'block';
      
      showStatus('ë ˆì´ì–´ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }

    // ë ˆì´ì–´ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ë°˜í™˜
    function getLayerIcon(type) {
      const icons = {
        'TEXT': 'ğŸ“',
        'RECTANGLE': 'â¬œ',
        'ELLIPSE': 'â­•',
        'POLYGON': 'ğŸ”·',
        'STAR': 'â­',
        'VECTOR': 'ğŸ¨'
      };
      return icons[type] || 'ğŸ“„';
    }

    // í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ
    function loadTemplateList() {
      showStatus('í…œí”Œë¦¿ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
      post('load-template-list');
    }

    // í…œí”Œë¦¿ ëª©ë¡ í‘œì‹œ
    function displayTemplateList(templates) {
      currentTemplates = templates || [];
      
      if (currentTemplates.length === 0) {
        document.getElementById('templateList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“„</div>
            <div class="empty-state-text">ë“±ë¡ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-state-subtext">ìƒˆ í…œí”Œë¦¿ì„ ìƒì„±í•´ë³´ì„¸ìš”</div>
          </div>
        `;
      } else {
        const templateListHtml = currentTemplates.map(template => `
          <div class="template-item" onclick="selectTemplate('${template.template_id}')">
            <div class="template-preview">
              ${template.preview_image ? 'ğŸ–¼ï¸' : 'ğŸ“„'}
            </div>
            <div class="template-info">
              <div class="template-name">${template.name}</div>
              <div class="template-description">${template.description || 'ì„¤ëª… ì—†ìŒ'}</div>
            </div>
            <div class="template-actions">
              <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); updateTemplate('${template.template_id}')">
                ğŸ”„ ì—…ë°ì´íŠ¸
              </button>
              <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteTemplate('${template.template_id}')">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </div>
          </div>
        `).join('');
        
        document.getElementById('templateList').innerHTML = templateListHtml;
      }
      
      document.getElementById('templateList').style.display = 'block';
      showStatus('í…œí”Œë¦¿ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
    }

    // í…œí”Œë¦¿ ì„ íƒ
    function selectTemplate(templateId) {
      selectedTemplate = currentTemplates.find(t => t.template_id === templateId);
      
      // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      event.currentTarget.classList.add('selected');
    }

    // í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
    function updateTemplate(templateId) {
      const template = currentTemplates.find(t => t.template_id === templateId);
      if (!template) return;
      
      selectedTemplate = template;
      
      // í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
      document.getElementById('templateName').value = template.name;
      document.getElementById('templateDescription').value = template.description || '';
      
      // í¼ í‘œì‹œ
      document.getElementById('templateForm').style.display = 'block';
      
      showStatus('í…œí”Œë¦¿ ìˆ˜ì • ëª¨ë“œ', 'info');
    }

    // í…œí”Œë¦¿ ì €ì¥
    function saveTemplate() {
      const name = document.getElementById('templateName').value.trim();
      const description = document.getElementById('templateDescription').value.trim();
      
      if (!name) {
        showStatus('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }
      
      if (currentLayers.length === 0) {
        showStatus('í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }
      
      const templateData = {
        name,
        description,
        layers: currentLayers,
        templateId: selectedTemplate ? selectedTemplate.template_id : null
      };
      
      if (selectedTemplate) {
        post('update-template', templateData);
      } else {
        post('save-template', templateData);
      }
      
      showStatus('í…œí”Œë¦¿ì„ ì €ì¥í•˜ëŠ” ì¤‘...', 'info');
    }

    // í…œí”Œë¦¿ ì‚­ì œ
    function deleteTemplate(templateId) {
      if (confirm('ì •ë§ë¡œ ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        post('delete-template', { templateId });
        showStatus('í…œí”Œë¦¿ì„ ì‚­ì œí•˜ëŠ” ì¤‘...', 'info');
      }
    }

    // í…œí”Œë¦¿ í¼ ì·¨ì†Œ
    function cancelTemplateForm() {
      document.getElementById('templateForm').style.display = 'none';
      document.getElementById('templateName').value = '';
      document.getElementById('templateDescription').value = '';
      selectedTemplate = null;
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      const statusClass = `status-indicator ${type}`;
      
      statusDiv.innerHTML = `
        <div class="fade-in" style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <span class="${statusClass}"></span>
          ${message}
        </div>
      `;
      
      statusDiv.style.display = 'block';
      
      // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
    window.addEventListener('message', (event) => {
      const message = event.data.pluginMessage;
      if (!message) return;
      
      switch (message.type) {
        case 'file-info':
          updateFileInfo(message.payload);
          break;
          
        case 'layer-analysis':
          displayLayerAnalysis(message.payload);
          break;
          
        case 'template-list':
          displayTemplateList(message.payload.templates);
          break;
          
        case 'template-saved':
          showStatus('í…œí”Œë¦¿ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          cancelTemplateForm();
          loadTemplateList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          break;
          
        case 'template-updated':
          showStatus('í…œí”Œë¦¿ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          cancelTemplateForm();
          loadTemplateList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          break;
          
        case 'template-deleted':
          showStatus('í…œí”Œë¦¿ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          loadTemplateList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          break;
          
        case 'error':
          showStatus(`ì˜¤ë¥˜: ${message.payload.message}`, 'error');
          break;
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ ì •ë³´ ìš”ì²­
    document.addEventListener('DOMContentLoaded', () => {
      post('get-file-info');
    });
  </script>
</body>
</html>