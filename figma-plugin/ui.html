<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>템플릿 웹 편집 설정</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body { 
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0;
      padding: 16px;
      background: #f8f9fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      margin: -16px -16px 24px -16px;
      border-radius: 0 0 12px 12px;
      text-align: center;
    }
    
    .header h1 { 
      margin: 0 0 8px; 
      font-size: 20px; 
      font-weight: 600;
    }
    
    .header p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .file-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 12px;
    }

    .file-info strong {
      color: #1976d2;
    }

    .auto-edit-notice {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .notice-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .notice-text {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .notice-subtext {
      font-size: 12px;
      opacity: 0.9;
    }

    .layer-summary {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      font-size: 14px;
      color: #666;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
      color: #4caf50;
    }

    .layer-preview {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .layer-preview h4 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #333;
    }

    .layer-list-compact {
      max-height: 200px;
      overflow-y: auto;
    }

    .layer-item-compact {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .layer-item-compact:last-child {
      margin-bottom: 0;
    }

    .layer-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .layer-info {
      flex: 1;
    }

    .layer-name {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .layer-type {
      font-size: 11px;
      color: #666;
    }

    .layer-status {
      font-size: 11px;
      color: #4caf50;
      font-weight: 500;
    }

    .template-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .template-section h3 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #333;
    }

    .template-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .template-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .template-item:hover {
      background: #e9ecef;
      border-color: #667eea;
    }

    .template-item.selected {
      background: #e3f2fd;
      border-color: #1976d2;
    }

    .template-preview {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      margin-right: 12px;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
    }

    .template-info {
      flex: 1;
    }

    .template-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .template-description {
      font-size: 12px;
      color: #666;
    }

    .template-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd8;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-indicator.success {
      background: #4caf50;
    }

    .status-indicator.warning {
      background: #ff9800;
    }

    .status-indicator.error {
      background: #f44336;
    }

    .status-indicator.info {
      background: #2196f3;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666;
    }

    .loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 13px;
      opacity: 0.7;
    }

    .hidden {
      display: none;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🎨 템플릿 웹 편집 설정</h1>
    <p>관리자용 템플릿 설정 도구</p>
  </div>

  <div class="file-info" id="fileInfo">
    <strong>파일:</strong> <span id="fileName">로딩 중...</span><br>
    <strong>키:</strong> <span id="fileKey">로딩 중...</span>
  </div>

  <!-- 자동 편집 모드 알림 -->
  <div class="auto-edit-notice">
    <div class="notice-icon">🤖</div>
    <div class="notice-text">자동 편집 모드</div>
    <div class="notice-subtext">모든 편집 가능한 레이어가 자동으로 활성화되었습니다</div>
  </div>

  <!-- 레이어 요약 -->
  <div class="layer-summary" id="layerSummary" style="display: none;">
    <div class="summary-item">
      <span class="summary-label">총 레이어:</span>
      <span class="summary-value" id="totalLayers">0개</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">편집 가능:</span>
      <span class="summary-value" id="editableLayers">0개</span>
    </div>
  </div>

  <!-- 레이어 미리보기 -->
  <div class="layer-preview" id="layerPreview" style="display: none;">
    <h4>편집 가능한 레이어 목록</h4>
    <div class="layer-list-compact" id="layerListCompact">
      <!-- 레이어 목록이 여기에 동적으로 생성됩니다 -->
    </div>
  </div>

  <!-- 템플릿 관리 섹션 -->
  <div class="template-section">
    <h3>📋 템플릿 관리</h3>
    
    <div class="form-group">
      <button class="btn btn-primary" onclick="loadTemplateList()">
        📋 템플릿 목록 불러오기
      </button>
    </div>

    <div id="templateList" class="template-list" style="display: none;">
      <!-- 템플릿 목록이 여기에 동적으로 생성됩니다 -->
    </div>

    <div id="templateForm" style="display: none;">
      <div class="form-group">
        <label for="templateName">템플릿 이름</label>
        <input type="text" id="templateName" placeholder="템플릿 이름을 입력하세요">
      </div>
      
      <div class="form-group">
        <label for="templateDescription">설명</label>
        <textarea id="templateDescription" placeholder="템플릿 설명을 입력하세요"></textarea>
      </div>
      
      <div class="form-group">
        <button class="btn btn-success" onclick="saveTemplate()">
          💾 템플릿 저장
        </button>
        <button class="btn btn-secondary" onclick="cancelTemplateForm()">
          ❌ 취소
        </button>
      </div>
    </div>
  </div>

  <!-- 상태 표시 -->
  <div id="statusMessage" style="display: none;"></div>

  <script>
    let currentLayers = [];
    let currentTemplates = [];
    let selectedTemplate = null;

    // 플러그인과 통신하는 함수
    function post(type, payload = {}) {
      parent.postMessage({ pluginMessage: { type, payload } }, '*');
    }

    // 파일 정보 업데이트
    function updateFileInfo(fileInfo) {
      document.getElementById('fileName').textContent = fileInfo.fileName || 'Unknown';
      document.getElementById('fileKey').textContent = fileInfo.fileKey || 'Unknown';
    }

    // 레이어 분석 결과 표시
    function displayLayerAnalysis(data) {
      currentLayers = data.layers || [];
      
      // 요약 정보 업데이트
      document.getElementById('totalLayers').textContent = `${currentLayers.length}개`;
      document.getElementById('editableLayers').textContent = `${currentLayers.filter(layer => layer.editable).length}개`;
      
      // 레이어 목록 생성
      const layerListHtml = currentLayers.map(layer => `
        <div class="layer-item-compact">
          <div class="layer-icon">${getLayerIcon(layer.type)}</div>
          <div class="layer-info">
            <div class="layer-name">${layer.name}</div>
            <div class="layer-type">${layer.type} - ${layer.editType}</div>
          </div>
          <div class="layer-status">✅ 편집 가능</div>
        </div>
      `).join('');
      
      document.getElementById('layerListCompact').innerHTML = layerListHtml;
      
      // 섹션 표시
      document.getElementById('layerSummary').style.display = 'block';
      document.getElementById('layerPreview').style.display = 'block';
      
      showStatus('레이어 분석이 완료되었습니다!', 'success');
    }

    // 레이어 타입에 따른 아이콘 반환
    function getLayerIcon(type) {
      const icons = {
        'TEXT': '📝',
        'RECTANGLE': '⬜',
        'ELLIPSE': '⭕',
        'POLYGON': '🔷',
        'STAR': '⭐',
        'VECTOR': '🎨'
      };
      return icons[type] || '📄';
    }

    // 템플릿 목록 로드
    function loadTemplateList() {
      showStatus('템플릿 목록을 불러오는 중...', 'info');
      post('load-template-list');
    }

    // 템플릿 목록 표시
    function displayTemplateList(templates) {
      currentTemplates = templates || [];
      
      if (currentTemplates.length === 0) {
        document.getElementById('templateList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📄</div>
            <div class="empty-state-text">등록된 템플릿이 없습니다</div>
            <div class="empty-state-subtext">새 템플릿을 생성해보세요</div>
          </div>
        `;
      } else {
        const templateListHtml = currentTemplates.map(template => `
          <div class="template-item" onclick="selectTemplate('${template.template_id}')">
            <div class="template-preview">
              ${template.preview_image ? '🖼️' : '📄'}
            </div>
            <div class="template-info">
              <div class="template-name">${template.name}</div>
              <div class="template-description">${template.description || '설명 없음'}</div>
            </div>
            <div class="template-actions">
              <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); updateTemplate('${template.template_id}')">
                🔄 업데이트
              </button>
              <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteTemplate('${template.template_id}')">
                🗑️ 삭제
              </button>
            </div>
          </div>
        `).join('');
        
        document.getElementById('templateList').innerHTML = templateListHtml;
      }
      
      document.getElementById('templateList').style.display = 'block';
      showStatus('템플릿 목록을 불러왔습니다', 'success');
    }

    // 템플릿 선택
    function selectTemplate(templateId) {
      selectedTemplate = currentTemplates.find(t => t.template_id === templateId);
      
      // 선택 상태 업데이트
      document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      event.currentTarget.classList.add('selected');
    }

    // 템플릿 업데이트
    function updateTemplate(templateId) {
      const template = currentTemplates.find(t => t.template_id === templateId);
      if (!template) return;
      
      selectedTemplate = template;
      
      // 폼에 기존 데이터 채우기
      document.getElementById('templateName').value = template.name;
      document.getElementById('templateDescription').value = template.description || '';
      
      // 폼 표시
      document.getElementById('templateForm').style.display = 'block';
      
      showStatus('템플릿 수정 모드', 'info');
    }

    // 템플릿 저장
    function saveTemplate() {
      const name = document.getElementById('templateName').value.trim();
      const description = document.getElementById('templateDescription').value.trim();
      
      if (!name) {
        showStatus('템플릿 이름을 입력해주세요', 'error');
        return;
      }
      
      if (currentLayers.length === 0) {
        showStatus('편집 가능한 레이어가 없습니다', 'error');
        return;
      }
      
      const templateData = {
        name,
        description,
        layers: currentLayers,
        templateId: selectedTemplate ? selectedTemplate.template_id : null
      };
      
      if (selectedTemplate) {
        post('update-template', templateData);
      } else {
        post('save-template', templateData);
      }
      
      showStatus('템플릿을 저장하는 중...', 'info');
    }

    // 템플릿 삭제
    function deleteTemplate(templateId) {
      if (confirm('정말로 이 템플릿을 삭제하시겠습니까?')) {
        post('delete-template', { templateId });
        showStatus('템플릿을 삭제하는 중...', 'info');
      }
    }

    // 템플릿 폼 취소
    function cancelTemplateForm() {
      document.getElementById('templateForm').style.display = 'none';
      document.getElementById('templateName').value = '';
      document.getElementById('templateDescription').value = '';
      selectedTemplate = null;
    }

    // 상태 메시지 표시
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      const statusClass = `status-indicator ${type}`;
      
      statusDiv.innerHTML = `
        <div class="fade-in" style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <span class="${statusClass}"></span>
          ${message}
        </div>
      `;
      
      statusDiv.style.display = 'block';
      
      // 3초 후 자동 숨김
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    // 메시지 수신 처리
    window.addEventListener('message', (event) => {
      const message = event.data.pluginMessage;
      if (!message) return;
      
      switch (message.type) {
        case 'file-info':
          updateFileInfo(message.payload);
          break;
          
        case 'layer-analysis':
          displayLayerAnalysis(message.payload);
          break;
          
        case 'template-list':
          displayTemplateList(message.payload.templates);
          break;
          
        case 'template-saved':
          showStatus('템플릿이 성공적으로 저장되었습니다!', 'success');
          cancelTemplateForm();
          loadTemplateList(); // 목록 새로고침
          break;
          
        case 'template-updated':
          showStatus('템플릿이 성공적으로 업데이트되었습니다!', 'success');
          cancelTemplateForm();
          loadTemplateList(); // 목록 새로고침
          break;
          
        case 'template-deleted':
          showStatus('템플릿이 성공적으로 삭제되었습니다!', 'success');
          loadTemplateList(); // 목록 새로고침
          break;
          
        case 'error':
          showStatus(`오류: ${message.payload.message}`, 'error');
          break;
      }
    });

    // 페이지 로드 시 파일 정보 요청
    document.addEventListener('DOMContentLoaded', () => {
      post('get-file-info');
    });
  </script>
</body>
</html>