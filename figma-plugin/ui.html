<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í…œí”Œë¦¿ ì›¹ í¸ì§‘ ì„¤ì •</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body { 
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0;
      padding: 16px;
      background: #f8f9fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      margin: -16px -16px 24px -16px;
      border-radius: 0 0 12px 12px;
      text-align: center;
    }
    
    .header h1 { 
      margin: 0 0 8px; 
      font-size: 20px; 
      font-weight: 600;
    }
    
    .header p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .file-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 12px;
    }

    .file-info strong {
      color: #1976d2;
    }
    
    .screen {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    .screen.active {
      display: block;
    }

    .mode-indicator {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 16px;
      font-size: 12px;
      font-weight: 500;
      color: #0369a1;
    }

    .mode-indicator.edit-mode {
      background: #fef3c7;
      border-color: #fbbf24;
      color: #92400e;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .template-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .template-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .template-item:hover {
      background: #f9fafb;
    }

    .template-item:last-child {
      border-bottom: none;
    }

    .template-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      background: #f3f4f6;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #6b7280;
    }

    .template-info {
      flex: 1;
    }

    .template-name {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 2px;
    }

    .template-date {
      font-size: 11px;
      color: #6b7280;
    }

    .template-select-btn {
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .template-delete-btn {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      margin-left: 4px;
    }

    .template-delete-btn:hover {
      background: #dc2626;
    }

    .template-actions {
      display: flex;
      align-items: center;
    }

    .layer-tree {
      display: flex;
      gap: 16px;
      height: 500px;
    }

    .layer-list {
      flex: 1;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow-y: auto;
      background: #fafafa;
    }

    .layer-item {
      padding: 8px 12px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }

    .layer-item:hover {
      background: #f0f9ff;
    }

    .layer-item.selected {
      background: #dbeafe;
      border-left: 3px solid #3b82f6;
    }

    .layer-item.editable {
      background: #f0fdf4;
    }

    .layer-item.editable.selected {
      background: #dcfce7;
      border-left-color: #10b981;
    }

    .layer-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .layer-type {
      font-size: 10px;
      color: #6b7280;
    }

    .layer-settings {
      flex: 1;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .settings-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #374151;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 12px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 12px;
      background: white;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox {
      width: 16px;
      height: 16px;
    }

    .checkbox-label {
      font-size: 12px;
      color: #374151;
      margin: 0;
    }

    .current-value {
      background: #f3f4f6;
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }

    .status.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 12px;
    }

    .preview-url {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 11px;
      font-family: monospace;
      word-break: break-all;
      margin-top: 8px;
    }

    .copy-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      margin-top: 4px;
    }

    .copy-btn:hover {
      background: #059669;
    }

    /* ìë™ í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    .auto-edit-notice {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
    }

    .notice-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .notice-text {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .notice-subtext {
      font-size: 11px;
      opacity: 0.9;
    }

    .layer-summary {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .summary-item {
      flex: 1;
      text-align: center;
    }

    .summary-label {
      display: block;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .summary-value {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    .layer-preview {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
    }

    .layer-preview h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .layer-list-compact {
      max-height: 200px;
      overflow-y: auto;
    }

    .layer-item-compact {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 12px;
    }

    .layer-item-compact:last-child {
      border-bottom: none;
    }

    .layer-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      border-radius: 4px;
      margin-right: 8px;
      font-size: 12px;
    }

    .layer-info {
      flex: 1;
    }

    .layer-name {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 2px;
    }

    .layer-type {
      font-size: 10px;
      color: #6b7280;
    }

    .layer-status {
      font-size: 10px;
      color: #10b981;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¨ í…œí”Œë¦¿ ì›¹ í¸ì§‘ ì„¤ì •</h1>
    <p>ê´€ë¦¬ììš© í”¼ê·¸ë§ˆ í…œí”Œë¦¿ ì„¤ì • ë„êµ¬</p>
  </div>

  <div class="file-info">
    <strong>í˜„ì¬ íŒŒì¼:</strong> <span id="currentFileName">ë¶„ì„ ì¤‘...</span>
  </div>

  <!-- ì´ˆê¸° í™”ë©´ -->
  <div id="initialScreen" class="screen active">
    <div class="button-group">
      <button class="btn btn-primary" onclick="showNewTemplateScreen()">
        âœ¨ ìƒˆ í…œí”Œë¦¿ ë§Œë“¤ê¸°
      </button>
      <button class="btn btn-secondary" onclick="showTemplateListScreen()">
        ğŸ“ ê¸°ì¡´ í…œí”Œë¦¿ ìˆ˜ì •í•˜ê¸°
      </button>
    </div>
  </div>

  <!-- í…œí”Œë¦¿ ëª©ë¡ í™”ë©´ -->
  <div id="templateListScreen" class="screen">
    <div class="mode-indicator">
      ğŸ“ ê¸°ì¡´ í…œí”Œë¦¿ ìˆ˜ì • ëª¨ë“œ
    </div>
    
    <div id="templateListContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>í…œí”Œë¦¿ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="showInitialScreen()">ì·¨ì†Œ</button>
    </div>
  </div>

  <!-- ë ˆì´ì–´ ì„ íƒ í™”ë©´ (ì‹ ê·œ) -->
  <div id="newTemplateScreen" class="screen">
    <div class="mode-indicator">
      âœ¨ ì‹ ê·œ ìƒì„± ëª¨ë“œ
    </div>

    <div id="layerSelectionContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>ë ˆì´ì–´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="showInitialScreen()">ì·¨ì†Œ</button>
      <button class="btn btn-success" onclick="saveNewTemplate()" id="saveNewBtn" disabled>ì €ì¥ ë° ì—…ë¡œë“œ</button>
    </div>
  </div>

  <!-- ë ˆì´ì–´ ì„ íƒ í™”ë©´ (ìˆ˜ì •) -->
  <div id="editTemplateScreen" class="screen">
    <div class="mode-indicator edit-mode">
      ğŸ“ ìˆ˜ì • ëª¨ë“œ: <span id="editingTemplateName">í…œí”Œë¦¿ëª…</span>
    </div>

    <div id="editLayerSelectionContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>ê¸°ì¡´ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="showTemplateListScreen()">ì·¨ì†Œ</button>
      <button class="btn btn-success" onclick="updateTemplate()" id="updateBtn" disabled>ì—…ë°ì´íŠ¸</button>
    </div>
  </div>

  <!-- ì™„ë£Œ í™”ë©´ -->
  <div id="completeScreen" class="screen">
    <div class="mode-indicator success">
      âœ… <span id="completeMessage">í…œí”Œë¦¿ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</span>
    </div>

    <div class="form-group">
      <label class="form-label">í…œí”Œë¦¿ ID</label>
      <div class="preview-url" id="templateId">template-id</div>
    </div>

    <div class="form-group">
      <label class="form-label">ì›¹ ë¯¸ë¦¬ë³´ê¸° URL</label>
      <div class="preview-url" id="previewUrl">https://example.com/preview</div>
      <button class="copy-btn" onclick="copyToClipboard('previewUrl')">URL ë³µì‚¬</button>
    </div>

    <div class="button-group">
      <button class="btn btn-primary" onclick="showInitialScreen()">ë‹¤ë¥¸ í…œí”Œë¦¿ ë§Œë“¤ê¸°/ìˆ˜ì •í•˜ê¸°</button>
      <button class="btn btn-secondary" onclick="closePlugin()">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="status" class="status"></div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let currentScreen = 'initial';
    let currentFileKey = '';
    let currentFileName = '';
    let layerData = [];
    let editableLayers = [];
    let selectedLayer = null;
    let currentTemplate = null;
    let templates = [];

    // í”¼ê·¸ë§ˆ í”ŒëŸ¬ê·¸ì¸ í™˜ê²½ í™•ì¸
    if (typeof parent === 'undefined') {
      window.parent = {
        postMessage: function(data, origin) {
          console.log('Mock postMessage:', data);
        }
      };
    }

    function post(type, payload) { 
      try {
        parent.postMessage({ pluginMessage: { type, payload } }, '*');
      } catch (error) {
        console.error('Post message error:', error);
        setStatus('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: ' + error.message, 'error');
      }
    }

    function onmessage(event) {
      try {
        const msg = event.data && event.data.pluginMessage;
        if (!msg) return;

        switch (msg.type) {
          case 'file-info':
            currentFileKey = msg.payload.fileKey;
            currentFileName = msg.payload.fileName;
            document.getElementById('currentFileName').textContent = currentFileName;
            break;

          case 'layer-analysis':
            layerData = msg.payload.layers || [];
            generateLayerSelectionUI();
            break;

          case 'template-list':
            templates = msg.payload.templates || [];
            generateTemplateListUI();
            break;

          case 'template-loaded':
            currentTemplate = msg.payload.template;
            // í…œí”Œë¦¿ ë¡œë“œ ì™„ë£Œ - ì´ë¯¸ generateLayerSelectionUIì—ì„œ ì²˜ë¦¬ë¨
            break;

          case 'template-saved':
            showCompleteScreen(msg.payload);
            break;

          case 'template-updated':
            showCompleteScreen(msg.payload, 'updated');
            break;

          case 'template-deleted':
            setStatus('í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            // í…œí”Œë¦¿ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
              loadTemplateList();
            }, 1000);
            break;

          case 'error':
            const errorMsg = msg.payload && msg.payload.message;
            setStatus('ì˜¤ë¥˜: ' + (errorMsg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            break;

          default:
            console.warn('Unknown message type:', msg.type);
        }
      } catch (error) {
        console.error('Message handling error:', error);
        setStatus('ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId.replace('Screen', '');
    }

    function showInitialScreen() {
      showScreen('initialScreen');
    }

    function showNewTemplateScreen() {
      showScreen('newTemplateScreen');
      analyzeLayers();
    }

    function showTemplateListScreen() {
      showScreen('templateListScreen');
      loadTemplateList();
    }

    function showEditTemplateScreen(template) {
      showScreen('editTemplateScreen');
      document.getElementById('editingTemplateName').textContent = template.name;
      
      // ë¨¼ì € ë ˆì´ì–´ë¥¼ ë¶„ì„í•œ ë‹¤ìŒ í…œí”Œë¦¿ì„ ë¡œë“œ
      setStatus('ë ˆì´ì–´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...', 'info');
      post('analyze-layers');
      
      // ë ˆì´ì–´ ë¶„ì„ ì™„ë£Œ í›„ í…œí”Œë¦¿ ë¡œë“œí•˜ë„ë¡ ì„¤ì •
      currentTemplate = template;
    }

    function showCompleteScreen(data, type = 'created') {
      showScreen('completeScreen');
      
      const message = type === 'updated' ? 'í…œí”Œë¦¿ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ìƒˆ í…œí”Œë¦¿ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤';
      document.getElementById('completeMessage').textContent = message;
      document.getElementById('templateId').textContent = data.templateId || 'unknown';
      document.getElementById('previewUrl').textContent = data.previewUrl || 'https://example.com/preview';
    }

    // ë ˆì´ì–´ ì•„ì´ì½˜ ë°˜í™˜ í•¨ìˆ˜
    function getLayerIcon(type) {
      switch (type) {
        case 'TEXT':
          return 'ğŸ“';
        case 'RECTANGLE':
          return 'â¬œ';
        case 'ELLIPSE':
          return 'â­•';
        case 'POLYGON':
          return 'ğŸ”·';
        case 'STAR':
          return 'â­';
        case 'VECTOR':
          return 'ğŸ¨';
        default:
          return 'ğŸ“„';
      }
    }

    // ë ˆì´ì–´ ë¶„ì„ ë° UI ìƒì„±
    function analyzeLayers() {
      setStatus('ë ˆì´ì–´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...', 'info');
      post('analyze-layers');
    }

    function generateLayerSelectionUI() {
      const container = document.getElementById('layerSelectionContainer');
      const editContainer = document.getElementById('editLayerSelectionContainer');
      const targetContainer = editContainer || container;
      
      if (layerData.length === 0) {
        targetContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“„</div>
            <div class="empty-state-text">í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-state-subtext">í…ìŠ¤íŠ¸, ì´ë¯¸ì§€, ë„í˜• ë ˆì´ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
          </div>
        `;
        return;
      }

      // ìë™ í¸ì§‘ ëª¨ë“œ - ëª¨ë“  ë ˆì´ì–´ê°€ í¸ì§‘ ê°€ëŠ¥í•˜ë„ë¡ í‘œì‹œ
      targetContainer.innerHTML = `
        <div class="auto-edit-notice">
          <div class="notice-icon">ğŸ¤–</div>
          <div class="notice-text">ìë™ í¸ì§‘ ëª¨ë“œ</div>
          <div class="notice-subtext">ëª¨ë“  í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ê°€ ìë™ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤</div>
        </div>
        <div class="layer-summary">
          <div class="summary-item">
            <span class="summary-label">ì´ ë ˆì´ì–´:</span>
            <span class="summary-value">${layerData.length}ê°œ</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">í¸ì§‘ ê°€ëŠ¥:</span>
            <span class="summary-value">${layerData.length}ê°œ</span>
          </div>
        </div>
        <div class="layer-preview">
          <h4>í¸ì§‘ ê°€ëŠ¥í•œ ë ˆì´ì–´ ëª©ë¡</h4>
          <div class="layer-list-compact">
            ${layerData.map(layer => `
              <div class="layer-item-compact">
                <div class="layer-icon">${getLayerIcon(layer.type)}</div>
                <div class="layer-info">
                  <div class="layer-name">${layer.name}</div>
                  <div class="layer-type">${layer.type} - ${layer.editType}</div>
                </div>
                <div class="layer-status">âœ… í¸ì§‘ ê°€ëŠ¥</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // ê¸°ì¡´ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ì„¤ì • ì ìš©
      if (currentTemplate && currentTemplate.nodes) {
        layerData.forEach(layer => {
          const nodeConfig = currentTemplate.nodes[layer.id];
          if (nodeConfig) {
            layer.editable = nodeConfig.editable || false;
            layer.label = nodeConfig.label || layer.name;
            layer.editType = nodeConfig.editType || 'text';
          }
        });
      }

      targetContainer.innerHTML = `
        <div class="layer-tree">
          <div class="layer-list">
            ${layerData.map(layer => `
              <div class="layer-item ${layer.editable ? 'editable' : ''}" onclick="selectLayer('${layer.id}')">
                <div class="layer-name">${layer.name}</div>
                <div class="layer-type">${layer.type}</div>
              </div>
            `).join('')}
          </div>
          <div class="layer-settings">
            <div class="settings-title">ë ˆì´ì–´ ì„¤ì •</div>
            <div id="layerSettingsContent">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘†</div>
                <div class="empty-state-text">ë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
              </div>
            </div>
          </div>
        </div>
      `;

      // ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ í™•ì¸
      updateSaveButton();

      if (currentTemplate) {
        setStatus('ê¸°ì¡´ í…œí”Œë¦¿ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } else {
        setStatus('ë ˆì´ì–´ ë¶„ì„ ì™„ë£Œ', 'success');
      }
    }

    function selectLayer(layerId) {
      selectedLayer = layerData.find(layer => layer.id === layerId);
      
      // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.layer-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // ì„¤ì • íŒ¨ë„ ì—…ë°ì´íŠ¸
      generateLayerSettings();
    }

    function generateLayerSettings() {
      if (!selectedLayer) return;

      const container = document.getElementById('layerSettingsContent');
      
      container.innerHTML = `
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="editable-${selectedLayer.id}" class="checkbox" 
                   ${selectedLayer.editable ? 'checked' : ''} 
                   onchange="toggleLayerEditable('${selectedLayer.id}', this.checked)">
            <label for="editable-${selectedLayer.id}" class="checkbox-label">ì›¹ í¸ì§‘ ê°€ëŠ¥</label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ë¼ë²¨ ì´ë¦„</label>
          <input type="text" class="form-input" id="label-${selectedLayer.id}" 
                 value="${selectedLayer.label || selectedLayer.name}" 
                 onchange="updateLayerLabel('${selectedLayer.id}', this.value)">
        </div>

        <div class="form-group">
          <label class="form-label">í¸ì§‘ íƒ€ì…</label>
          <select class="form-select" id="editType-${selectedLayer.id}" 
                  onchange="updateLayerEditType('${selectedLayer.id}', this.value)">
            <option value="text" ${selectedLayer.editType === 'text' ? 'selected' : ''}>í…ìŠ¤íŠ¸ ìˆ˜ì •</option>
            <option value="image" ${selectedLayer.editType === 'image' ? 'selected' : ''}>ì´ë¯¸ì§€ êµì²´</option>
            <option value="shape" ${selectedLayer.editType === 'shape' ? 'selected' : ''}>ë„í˜• ë³€ê²½</option>
            <option value="color" ${selectedLayer.editType === 'color' ? 'selected' : ''}>ìƒ‰ìƒ ë³€ê²½</option>
            <option value="size" ${selectedLayer.editType === 'size' ? 'selected' : ''}>í¬ê¸° ë³€ê²½</option>
            <option value="position" ${selectedLayer.editType === 'position' ? 'selected' : ''}>ìœ„ì¹˜ ë³€ê²½</option>
          </select>
        </div>

        <div class="current-value">
          <strong>í˜„ì¬ ê°’:</strong> ${selectedLayer.currentValue || 'ì—†ìŒ'}
        </div>
      `;
    }

    function toggleLayerEditable(layerId, editable) {
      const layer = layerData.find(l => l.id === layerId);
      if (layer) {
        layer.editable = editable;
        updateLayerItemStyle(layerId);
        updateSaveButton();
      }
    }

    function updateLayerLabel(layerId, label) {
      const layer = layerData.find(l => l.id === layerId);
      if (layer) {
        layer.label = label;
      }
    }

    function updateLayerEditType(layerId, editType) {
      const layer = layerData.find(l => l.id === layerId);
      if (layer) {
        layer.editType = editType;
      }
    }

    function updateLayerItemStyle(layerId) {
      const layerItem = document.querySelector(`[onclick="selectLayer('${layerId}')"]`);
      if (layerItem) {
        const layer = layerData.find(l => l.id === layerId);
        if (layer && layer.editable) {
          layerItem.classList.add('editable');
        } else {
          layerItem.classList.remove('editable');
        }
      }
    }

    function updateSaveButton() {
      const editableCount = layerData.filter(layer => layer.editable).length;
      const saveBtn = document.getElementById('saveNewBtn');
      const updateBtn = document.getElementById('updateBtn');
      
      if (saveBtn) saveBtn.disabled = editableCount === 0;
      if (updateBtn) updateBtn.disabled = editableCount === 0;
    }

    // í…œí”Œë¦¿ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    function loadTemplateList() {
      setStatus('í…œí”Œë¦¿ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
      post('load-template-list');
    }

    function generateTemplateListUI() {
      const container = document.getElementById('templateListContainer');
      
      if (templates.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-text">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-state-subtext">ìƒˆ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="template-list">
          ${templates.map(template => `
            <div class="template-item" onclick="showEditTemplateScreen(${JSON.stringify(template).replace(/"/g, '&quot;')})">
              <div class="template-thumbnail">
                ${template.preview_image ? 'ğŸ–¼ï¸' : 'ğŸ“„'}
              </div>
              <div class="template-info">
                <div class="template-name">${template.name}</div>
                <div class="template-date">${new Date(template.updated_at).toLocaleDateString('ko-KR')}</div>
              </div>
              <div class="template-actions">
                <button class="template-select-btn" onclick="event.stopPropagation(); showEditTemplateScreen(${JSON.stringify(template).replace(/"/g, '&quot;')})">
                  ì„ íƒ
                </button>
                <button class="template-delete-btn" onclick="event.stopPropagation(); deleteTemplate('${template.template_id}')">
                  ì‚­ì œ
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      setStatus('í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ ì™„ë£Œ', 'success');
    }

    function deleteTemplate(templateId) {
      if (!confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ í…œí”Œë¦¿ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }

      setStatus('í…œí”Œë¦¿ì„ ì‚­ì œí•˜ëŠ” ì¤‘...', 'info');
      post('delete-template', { templateId });
    }


    function saveNewTemplate() {
      const editableLayers = layerData.filter(layer => layer.editable);
      
      if (editableLayers.length === 0) {
        setStatus('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë ˆì´ì–´ë¥¼ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      setStatus('í…œí”Œë¦¿ì„ ì €ì¥í•˜ëŠ” ì¤‘...', 'info');
      
      const templateData = {
        name: prompt('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentFileName) || currentFileName,
        description: prompt('í…œí”Œë¦¿ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):', '') || '',
        fileKey: currentFileKey,
        layers: layerData,
        editableLayers: editableLayers
      };

      post('save-template', templateData);
    }

    function updateTemplate() {
      const editableLayers = layerData.filter(layer => layer.editable);
      
      if (editableLayers.length === 0) {
        setStatus('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë ˆì´ì–´ë¥¼ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      setStatus('í…œí”Œë¦¿ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘...', 'info');
      
      const templateData = {
        templateId: currentTemplate.template_id,
        layers: layerData,
        editableLayers: editableLayers
      };

      post('update-template', templateData);
    }

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        setStatus('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      }).catch(() => {
        setStatus('URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
      });
    }

    function closePlugin() {
      post('close');
    }

    function setStatus(text, type) {
      const statusDiv = document.getElementById('status');
      if (!statusDiv) return;
      
      statusDiv.textContent = text || '';
      statusDiv.className = `status ${type || 'info'}`;
      statusDiv.style.display = 'block';
      
      // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // íŒŒì¼ ì •ë³´ ìš”ì²­
        post('get-file-info');
      } catch (error) {
        console.error('Initialization error:', error);
        setStatus('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    });

    // ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    window.addEventListener('message', onmessage);
  </script>
</body>
</html>